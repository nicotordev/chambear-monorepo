generator client {
  provider   = "prisma-client-js"
  output     = "../src/lib/generated"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  EMPLOYER
  EMPLOYEE
  ADMIN
}

/**
 * =========================================================
 * Types (keep your app types outside; this client is general)
 * =========================================================
 */

enum UrlKind {
  JOB_LISTING
  JOBS_INDEX
  CAREERS
  LOGIN_OR_GATE
  BLOG_OR_NEWS
  COMPANY_ABOUT
  IRRELEVANT
}

enum Seniority {
  JUNIOR
  MID
  SENIOR
  STAFF
  LEAD
  PRINCIPAL
  UNKNOWN
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
  FREELANCE
  UNKNOWN
}

enum WorkMode {
  ONSITE
  HYBRID
  REMOTE
  UNKNOWN
}

enum ApplicationStatus {
  SAVED
  APPLIED
  INTERVIEW
  INTERVIEWING
  OFFER
  REJECTED
  HIRED
  ARCHIVED
}

enum DocumentType {
  RESUME
  COVER_LETTER
  NOTE
  OTHER
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum JobSource {
  MANUAL
  IMPORT
  EXTERNAL_API
  PARTNER
}

enum InterviewMode {
  VIRTUAL
  ONSITE
  HYBRID
}

enum InterviewStatus {
  PLANNING
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum ReminderType {
  FOLLOW_UP
  INTERVIEW_PREP
  DEADLINE
}

enum PlanTier {
  FREE
  BASE
  PRO
  RESULT
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  EXPIRED
}

enum CreditActionType {
  CV_OPTIMIZATION
  COVER_LETTER
  CV_EXTRACTION
  INTERVIEW_SIMULATION
  SKILL_GAP_ANALYSIS
  JOB_SCAN
  OTHER
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  clerkId          String   @unique
  name             String?
  role             Role     @default(EMPLOYEE)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  stripeCustomerId String?

  profiles     Profile[]
  subscription Subscription?
  creditWallet CreditWallet?
}

model Profile {
  id                  String   @id @default(cuid())
  onboardingCompleted Boolean  @default(false)
  avatar              String?
  userId              String   @unique
  headline            String?
  summary             String?
  location            String?
  yearsExperience     Int?
  targetRoles         String[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id])
  experiences       Experience[]
  educations        Education[]
  skills            ProfileSkill[]
  documents         Document[]
  applications      Application[]
  fitScores         FitScore[]
  jobPreferences    JobPreference[]
  interviewSessions InterviewSession[]
  reminders         Reminder[]
  certifications    Certification[]
}

model Experience {
  id         String    @id @default(cuid())
  profileId  String
  title      String
  company    String
  startDate  DateTime
  endDate    DateTime?
  current    Boolean   @default(false)
  summary    String?
  highlights String[]
  location   String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  profile Profile @relation(fields: [profileId], references: [id])
}

model Education {
  id           String    @id @default(cuid())
  profileId    String
  school       String
  degree       String?
  fieldOfStudy String?
  startDate    DateTime?
  endDate      DateTime?
  current      Boolean   @default(false)
  description  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  profile Profile @relation(fields: [profileId], references: [id])
}

model Certification {
  id                  String    @id @default(cuid())
  profileId           String
  name                String
  issuingOrganization String
  issueDate           DateTime
  expirationDate      DateTime?
  credentialId        String?
  credentialUrl       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  profile Profile @relation(fields: [profileId], references: [id])
}

model Skill {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  profiles ProfileSkill[]
  jobs     JobSkill[]
}

model ProfileSkill {
  profileId String
  skillId   String
  level     SkillLevel?

  profile Profile @relation(fields: [profileId], references: [id])
  skill   Skill   @relation(fields: [skillId], references: [id])

  @@id([profileId, skillId])
}

model Job {
  id             String         @id @default(cuid())
  title          String
  companyName    String
  location       String?
  seniority      Seniority      @default(UNKNOWN)
  employmentType EmploymentType @default(UNKNOWN)
  workMode       WorkMode       @default(UNKNOWN)
  description    String?
  source         JobSource      @default(MANUAL)
  urlKind        UrlKind        @default(IRRELEVANT)
  externalUrl    String?        @unique
  salary         String?
  tags           String[]
  postedAt       DateTime?
  expiresAt      DateTime?
  rawData        Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  algoliaId      String?

  applications   Application[]
  fitScores      FitScore[]
  jobSkills      JobSkill[]
  documents      Document[]
  interviews     InterviewSession[]
  reminders      Reminder[]
  company        Company?           @relation(fields: [companyId], references: [id])
  companyId      String?
  jobPreferences JobPreference[]
}

model Company {
  id        String   @id @default(cuid())
  name      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  jobs      Job[]
}

model JobSkill {
  jobId   String
  skillId String
  job     Job    @relation(fields: [jobId], references: [id])
  skill   Skill  @relation(fields: [skillId], references: [id])

  @@id([jobId, skillId]) // o @@unique([jobId, skillId])
}

model Application {
  id               String            @id @default(cuid())
  jobId            String
  status           ApplicationStatus @default(SAVED)
  appliedAt        DateTime?
  notes            String?
  resumeDocumentId String?
  coverLetterId    String?
  followUpAt       DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  job            Job        @relation(fields: [jobId], references: [id])
  resumeDocument Document?  @relation("ApplicationResume", fields: [resumeDocumentId], references: [id])
  coverLetter    Document?  @relation("ApplicationCoverLetter", fields: [coverLetterId], references: [id])
  reminders      Reminder[]
  profile        Profile    @relation(fields: [profileId], references: [id])
  profileId      String

  @@unique([profileId, jobId])
  @@index([status])
}

model Document {
  id        String       @id @default(cuid())
  profileId String
  jobId     String?
  type      DocumentType
  label     String
  content   String
  url       String?
  version   Int          @default(1)
  summary   String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  profile Profile @relation(fields: [profileId], references: [id])
  job     Job?    @relation(fields: [jobId], references: [id])

  applicationResume      Application[] @relation("ApplicationResume")
  applicationCoverLetter Application[] @relation("ApplicationCoverLetter")
}

model FitScore {
  id        String   @id @default(cuid())
  jobId     String
  /// 0..100 AI fitness score
  score     Int
  rationale Json?
  createdAt DateTime @default(now())

  job       Job     @relation(fields: [jobId], references: [id])
  profile   Profile @relation(fields: [profileId], references: [id])
  profileId String

  @@unique([profileId, jobId])
  @@index([score])
}

model JobPreference {
  id        String   @id @default(cuid())
  profileId String
  jobId     String
  liked     Boolean
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile Profile @relation(fields: [profileId], references: [id])
  job     Job     @relation(fields: [jobId], references: [id])

  @@unique([profileId, jobId])
}

model InterviewSession {
  id              String          @id @default(cuid())
  profileId       String
  jobId           String
  mode            InterviewMode   @default(VIRTUAL)
  status          InterviewStatus @default(PLANNING)
  scheduledFor    DateTime?
  meetLink        String?
  durationMinutes Int?
  notes           String?
  aiFeedback      Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  profile Profile @relation(fields: [profileId], references: [id])
  job     Job     @relation(fields: [jobId], references: [id])
}

model Reminder {
  id            String       @id @default(cuid())
  profileId     String
  jobId         String?
  applicationId String?
  type          ReminderType
  dueAt         DateTime
  sentAt        DateTime?
  completedAt   DateTime?
  message       String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  profile     Profile      @relation(fields: [profileId], references: [id])
  job         Job?         @relation(fields: [jobId], references: [id])
  application Application? @relation(fields: [applicationId], references: [id])

  @@index([dueAt])
}

model Plan {
  id              String   @id @default(cuid())
  tier            PlanTier @unique
  name            String
  monthlyPriceUsd Int /// ej: 1999 = $19.99
  monthlyCredits  Int
  description     String?
  stripePriceId   String?  @unique
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id                 String             @id @default(cuid())
  userId             String             @unique
  planId             String
  status             SubscriptionStatus
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)

  provider      String /// stripe, paddle, lemonsqueezy
  providerSubId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])
}

model CreditMovement {
  id        String            @id @default(cuid())
  walletId  String
  amount    Int /// positivo = recarga, negativo = consumo
  action    CreditActionType?
  meta      Json?
  createdAt DateTime          @default(now())

  wallet CreditWallet @relation(fields: [walletId], references: [id])

  @@index([createdAt])
}

model CreditWallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  user      User             @relation(fields: [userId], references: [id])
  movements CreditMovement[]
}
